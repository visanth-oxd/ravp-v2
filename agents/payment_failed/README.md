# Payment Failed Agent

Agent that explains payment failures and suggests resolutions using the Agent SDK.

## Overview

This agent demonstrates how to use the `RegulatedAgent` SDK with **LLM integration** to:
- Load agent definition from Agent Registry
- Use only allowed tools via ToolGateway
- Use LLM for intelligent reasoning and decision making
- Enforce policies via PolicyClient
- Audit all actions via AuditClient

## Capabilities

The Payment Failed Agent can:

1. **Investigate Payment Exceptions** - Fetches exception and customer data, uses LLM to analyze and suggest resolution
2. **Explain Payment Failures** - Generates human-readable explanations using LLM
3. **Execute Payment Retries** - Actually retries failed payments after investigation and policy checks
4. **Policy Enforcement** - Automatically checks policies before executing retries
5. **Full Audit Trail** - Logs all actions, tool calls, policy checks, and decisions

## Usage

### Interactive CLI (Recommended)

The easiest way to interact with the agent:

```bash
# Run the CLI
python agents/payment_failed/cli.py

# Commands available:
#   investigate <exception_id>  - Investigate a payment exception
#   explain <exception_id>      - Get explanation of payment failure
#   retry <exception_id>         - Execute payment retry (with checks)
#   retry-force <exception_id>   - Force retry (skip checks, use with caution)
#   help                         - Show help
#   exit                         - Exit CLI
```

### Python API

```python
from agents.payment_failed.agent import PaymentFailedAgent

# Create agent (automatically loads definition, checks kill-switch)
agent = PaymentFailedAgent()

# 1. Investigate payment exception
result = agent.investigate_payment_exception("EX-2025-001")
print(f"Suggested action: {result['suggested_action']}")
print(f"Confidence: {result['confidence']:.1%}")

# 2. Get human-readable explanation
explanation = agent.explain_payment_failure("EX-2025-001")
print(explanation)

# 3. Execute payment retry (with investigation and policy checks)
retry_result = agent.retry_payment("EX-2025-001")
print(f"Retry status: {retry_result['status']}")
print(f"Retry ID: {retry_result.get('retry_id')}")
```

### With Custom Control-Plane URL

```python
agent = PaymentFailedAgent(control_plane_url="http://localhost:8010")
```

## How It Works

### Investigation Flow (`investigate_payment_exception`)

1. **Loads Definition** - From Agent Registry (or file fallback)
2. **Checks Kill-Switch** - Verifies agent and model are enabled
3. **Registers Tools** - Registers tool implementations with ToolGateway
4. **Initializes LLM** - Creates LLM client for AI reasoning
5. **Fetches Exception Data** - Gets payment exception details via `get_payment_exception` tool
6. **Fetches Customer Data** - Gets customer profile via `get_customer_profile` tool
7. **LLM Reasoning** - Uses LLM to analyze exception and suggest resolution (retry/escalate/waive_fee)
8. **Checks Policy** - Evaluates payment retry policy if retry is suggested (governance layer)
9. **Suggests Resolution** - Records suggestion via `suggest_payment_resolution` tool
10. **Audits Everything** - Logs all tool calls, policy checks, LLM reasoning, decisions

### Retry Execution Flow (`retry_payment`)

1. **Investigation** - Runs full investigation (unless `force=True`)
2. **Validation** - Verifies retry is suggested and policy allows it
3. **Execution** - Calls `execute_payment_retry` tool to actually retry the payment
4. **Audit** - Logs retry execution and result

### Explanation Flow (`explain_payment_failure`)

1. **Investigation** - Runs full investigation to gather data
2. **LLM Explanation** - Uses LLM to generate human-readable explanation
3. **Returns** - Returns formatted explanation text

## Example Output

```
Payment Exception EX-2025-001 failed due to insufficient funds. The customer's 
account had a balance of £3,000 but the payment required £5,000. 

Based on the customer's good payment history and the temporary nature of this 
issue, I recommend retrying the payment after verifying the account balance. 
The customer has a standard tier account with active status and verified KYC.

Suggested Action: retry
Confidence: 85%
Evidence:
- Insufficient funds is temporary
- Customer has good payment history  
- Amount is within policy limits
- No previous retry attempts

Note: Colleague must confirm this action in the system before it is executed.
```

**Note**: Output is now generated by LLM, so it will vary based on the specific exception and customer data.

## Integration with Control-Plane

The agent automatically integrates with:
- **Agent Registry** - Loads agent definition
- **Kill Switch** - Checks if disabled
- **Tool Registry** - Validates tools
- **Policy Registry** - Evaluates policies
- **Audit Store** - Logs all actions

## Setup

**Required:**
```bash
# Install dependencies
pip install -r requirements.txt

# Set Google API key for LLM
export GOOGLE_API_KEY=your_google_api_key_here
```

## Example Workflows

### Workflow 1: Investigate and Explain

```python
agent = PaymentFailedAgent()

# Investigate
result = agent.investigate_payment_exception("EX-2025-001")
print(f"Suggested: {result['suggested_action']}")

# Get explanation
explanation = agent.explain_payment_failure("EX-2025-001")
print(explanation)
```

### Workflow 2: Investigate and Retry

```python
agent = PaymentFailedAgent()

# Investigate first
result = agent.investigate_payment_exception("EX-2025-001")

# If retry is suggested and allowed, execute it
if result['suggested_action'] == 'retry' and result.get('policy_check', {}).get('allowed'):
    retry_result = agent.retry_payment("EX-2025-001")
    print(f"Retry executed: {retry_result['status']}")
else:
    print(f"Cannot retry: {result.get('policy_check', {}).get('reason', 'N/A')}")
```

### Workflow 3: Direct Retry (with automatic investigation)

```python
agent = PaymentFailedAgent()

# This will investigate, check policy, and execute retry automatically
retry_result = agent.retry_payment("EX-2025-001")
print(f"Retry status: {retry_result['status']}")
```

## Testing

```bash
# Run agent test (requires GOOGLE_API_KEY)
python tests/test_payment_failed_agent.py

# Or use the CLI for interactive testing
python agents/payment_failed/cli.py
```

**Note**: The agent requires `GOOGLE_API_KEY` to be set. Without it, the agent will raise an error when trying to use LLM.
